## 4. 条件构造器

### 4.1 wrapper简介

Wrapper：条件构造抽象类，最顶端父类

​		AbstractWrapper：用于查询条件封装，生成sql的where条件

​				QueryWrapper：查询条件封装

​				UpdateWrapper：Update条件封装

​				AbstractLambdaWrapper：使用Lambda语法

​						LambdaQueryWrapper：用于Lambda语法使用的查询Wrapper

​						LambdaUpdateWrapper：用于Lambda语法使用的更新Wrapper

### 4.2 QueryWrapper

**组装查询条件**：

测试类MyBatisPlusWrapperTest：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test01() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.like("user_name", "a")
                .between("age", 20, 30)
                .isNotNull("email");
        List<User> users = userMapper.selectList(queryWrapper);
        users.forEach(System.out::println);
    }
}
```

QueryWrapper中的条件要使用数据库表中的字段名，而不是实体类中的属性名

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 AND (user_name LIKE ? AND age BETWEEN ? AND ? AND email IS NOT NULL)
==> Parameters: %a%(String), 20(Integer), 30(Integer)
<==    Columns: id, name, age, email, is_deleted
<==        Row: 4, Sandy, 21, test4@baomidou.com, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@481e91b6]
User(id=4, name=Sandy, age=21, email=test4@baomidou.com, isDeleted=0)
```

**组装排序条件**：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test02() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.orderByDesc("age").orderByAsc("uid");
        List<User> users = userMapper.selectList(queryWrapper);
        users.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 ORDER BY age DESC,uid ASC
==> Parameters: 
<==    Columns: id, name, age, email, is_deleted
<==        Row: 5, Billie, 24, test5@baomidou.com, 0
<==        Row: 4, Sandy, 21, test4@baomidou.com, 0
<==        Row: 6, 张珊, 18, zs@qq.com, 0
<==      Total: 3
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3cbf1ba4]
User(id=5, name=Billie, age=24, email=test5@baomidou.com, isDeleted=0)
User(id=4, name=Sandy, age=21, email=test4@baomidou.com, isDeleted=0)
User(id=6, name=张珊, age=18, email=zs@qq.com, isDeleted=0)
```

**组装删除条件**：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test03() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.isNull("email");
        int result = userMapper.delete(queryWrapper);
        System.out.println("result: " + result);
    }
}
```

结果：

```
==>  Preparing: UPDATE t_user SET is_deleted=1 WHERE is_deleted=0 AND (email IS NULL)
==>  Parameters: 
<==  Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@44c13103]
result: 1
```

**实现修改功能**：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test04() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.gt("age", 20).like("user_name", "a")
                .or().isNull("email");

        User user = new User();
        user.setName("晓明");
        user.setEmail("test@163.com");

        int result = userMapper.update(user, queryWrapper);
        System.out.println("result: " + result);
    }
}
```

结果：

```
==>  Preparing: UPDATE t_user SET user_name=?, email=? WHERE is_deleted=0 AND (age > ? AND user_name LIKE ? OR email IS NULL)
==>  Parameters: 晓明(String), test@163.com(String), 20(Integer), %a%(String)
<==  Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@140d1230]
result: 1
```

**条件的优先级**：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test05() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.like("user_name", "a")
                .and(i -> i.gt("age", 19).or().isNull("email"));

        User user = new User();
        user.setName("晓鸿");
        user.setEmail("test@163.com");

        int result = userMapper.update(user, queryWrapper);
        System.out.println("result: " + result);
    }
}
```

结果：

```
==>  Preparing: UPDATE t_user SET user_name=?, email=? WHERE is_deleted=0 AND (user_name LIKE ? AND (age > ? OR email IS NULL))
==>  Parameters: 晓鸿(String), test@163.com(String), %a%(String), 19(Integer)
<==  Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@ac20bb4]
result: 1
```

**组装Select字句**：

如果只想查询某一些字段，该如何处理

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test06() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.select("user_name", "age", "email");

        List<Map<String, Object>> maps = userMapper.selectMaps(queryWrapper);
        maps.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT user_name,age,email FROM t_user WHERE is_deleted=0
==> Parameters: 
<==    Columns: user_name, age, email
<==        Row: 晓明, 21, test@163.com
<==        Row: Billie, 24, test5@baomidou.com
<==        Row: 张珊, 18, zs@qq.com
<==        Row: 晓鸿, null, test@163.com
<==      Total: 4
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@12d1f1d4]
{user_name=晓明, age=21, email=test@163.com}
{user_name=Billie, age=24, email=test5@baomidou.com}
{user_name=张珊, age=18, email=zs@qq.com}
{user_name=晓鸿, email=test@163.com}
```

**组装子查询**：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test08() {
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.inSql("uid", "select uid from t_user where uid <= 100");
        List<Map<String, Object>> maps = userMapper.selectMaps(queryWrapper);
        maps.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 AND (uid IN (select uid from t_user where uid <= 100))
==> Parameters: 
<==    Columns: id, name, age, email, is_deleted
<==        Row: 4, 晓明, 21, test@163.com, 0
<==        Row: 5, Billie, 24, test5@baomidou.com, 0
<==        Row: 6, 张珊, 18, zs@qq.com, 0
<==        Row: 7, 晓鸿, null, test@163.com, 0
<==      Total: 4
```

### 4.3 UpdateWrapper

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test09() {
        UpdateWrapper<User> updateWrapper = new UpdateWrapper<>();
        updateWrapper.like("user_name", "a").and(i -> i.gt("age", 20).or().isNull("email"));
        updateWrapper.set("user_name", "修修").set("email", "xiuxiu@qq.com");
        int result = userMapper.update(null, updateWrapper);
        System.out.println("result: " + result);
    }
}
```

结果：

```
==>  Preparing: UPDATE t_user SET user_name=?,email=? WHERE is_deleted=0 AND (user_name LIKE ? AND (age > ? OR email IS NULL))
==>  Parameters: 修修(String), xiuxiu@qq.com(String), %a%(String), 20(Integer)
<==  Updates: 0
```

### 4.4 模拟开发中组装条件的情况

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test10() {
        String username = "";
        Integer ageBegin = 20;
        Integer ageEnd = 30;
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        if (StringUtils.isNotBlank(username)) {
            queryWrapper.like("user_name", username);
        }
        if (ageBegin != null) {
            queryWrapper.ge("age", ageBegin);
        }
        if (ageEnd != null) {
            queryWrapper.le("age", ageEnd);
        }
        List<User> users = userMapper.selectList(queryWrapper);
        users.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 AND (age >= ? AND age <= ?)
==>  Parameters: 20(Integer), 30(Integer)
<==   Columns: id, name, age, email, is_deleted
<==        Row: 4, 晓明, 21, test@163.com, 0
<==        Row: 5, Billie, 24, test5@baomidou.com, 0
<==      Total: 2
```

### 4.5 condition组装条件

测试类：

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test11() {
        String username = "a";
        Integer ageBegin = 20;
        Integer ageEnd = 30;
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.like(StringUtils.isNotBlank(username), "user_name", username)
                .ge(ageBegin != null, "age", ageBegin)
                .le(ageEnd != null, "age", ageEnd);
        List<User> users = userMapper.selectList(queryWrapper);
        users.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 AND (user_name LIKE ? AND age >= ? AND age <= ?)
==> Parameters: %a%(String), 20(Integer), 30(Integer)
<==    Columns: id, name, age, email, is_deleted
<==        Row: 2, Jack, 20, test2@baomidou.com, 0
<==      Total: 1
```

### 4.6 LambdaQueryWrapper

使用LambdaQueryWrapper可以防止写错字段名

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test12() {
        String username = "a";
        Integer ageBegin = 20;
        Integer ageEnd = 30;
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(StringUtils.isNotBlank(username), User::getName, username)
                .ge(ageBegin != null, User::getAge, ageBegin)
                .le(ageEnd != null, User::getAge, ageEnd);
        List<User> users = userMapper.selectList(wrapper);
        users.forEach(System.out::println);
    }
}
```

结果：

```
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 AND (user_name LIKE ? AND age >= ? AND age <= ?)
==> Parameters: %a%(String), 20(Integer), 30(Integer)
<==    Columns: id, name, age, email, is_deleted
<==        Row: 2, Jack, 20, test2@baomidou.com, 0
<==      Total: 1
```

### 4.7 LambdaUpdateWrapper

```java
@SpringBootTest
public class MyBatisPlusWrapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void test13() {
        LambdaUpdateWrapper<User> wrapper = new LambdaUpdateWrapper<>();
        wrapper.like(User::getAge, "a")
                .and(i -> i.gt(User::getAge, 20).or().isNull(User::getEmail));
        wrapper.set(User::getName, "哈哈").set(User::getEmail, "haha@qq.com");
        int result = userMapper.update(null, wrapper);
        System.out.println("result: " + result);
    }
}
```

结果：

```
==>  Preparing: UPDATE t_user SET user_name=?,email=? WHERE is_deleted=0 AND (age LIKE ? AND (age > ? OR email IS NULL))
==> Parameters: 哈哈(String), haha@qq.com(String), %a%(String), 20(Integer)
<==    Updates: 0
```





