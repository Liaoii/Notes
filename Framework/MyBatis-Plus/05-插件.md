## 5. 插件

### 5.1 分页插件

新增配置类：

```java
@Configuration
@MapperScan("com.liaoii.mybatisplus.mapper")
public class MyBatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

测试类：

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void testPage() {
        Page<User> page = new Page<>(1, 3);
        userMapper.selectPage(page, null);
        System.out.println(page);
    }
}
```

结果：

```
==>  Preparing: SELECT COUNT(*) AS total FROM t_user WHERE is_deleted = 0
==> Parameters: 
<==    Columns: total
<==        Row: 13
<==      Total: 1
==>  Preparing: SELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0 LIMIT ?
==> Parameters: 3(Long)
<==    Columns: id, name, age, email, is_deleted
<==        Row: 1, Jone, 18, test1@baomidou.com, 0
<==        Row: 2, Jack, 20, test2@baomidou.com, 0
<==        Row: 3, Tom, 28, test3@baomidou.com, 0
<==      Total: 3
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2b8bd798]
com.baomidou.mybatisplus.extension.plugins.pagination.Page@571a01f9
```

**分页相关数据**：

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void testPage() {
        Page<User> page = new Page<>(1, 3);
        userMapper.selectPage(page, null);
        System.out.println(page.getRecords());
        System.out.println(page.getTotal());
        System.out.println(page.getPages());
        System.out.println(page.hasPrevious());
        System.out.println(page.hasNext());
    }
}
```

结果：

```
[User(id=1, name=Jone, age=18, email=test1@baomidou.com, isDeleted=0), User(id=2, name=Jack, age=20, email=test2@baomidou.com, isDeleted=0), User(id=3, name=Tom, age=28, email=test3@baomidou.com, isDeleted=0)]
13
5
false
true
```

**自定义分页功能**：

开启类型别名：

```yaml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      table-prefix: t_
      id-type: AUTO
  type-aliases-package: com.liaoii.mybatisplus.entity
```

**UserMapper**

```java
@Repository
public interface UserMapper extends BaseMapper<User> {
    Page<User> selectPageVo(@Param("page") Page<User> page, @Param("age") Integer age);
}
```

**UserMapper.xml**

```xml
<mapper namespace="com.liaoii.mybatisplus.mapper.UserMapper">
    <select id="selectPageVo" resultType="User">
        select uid, user_name, age, email
        from t_user
        where age > #{age}
    </select>
</mapper>
```

**MyBatisPlusPluginsTest**

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void testPageVo() {
        Page<User> page = new Page<>(1, 3);
        userMapper.selectPageVo(page, 20);
        System.out.println(page.getRecords());
        System.out.println(page.getTotal());
        System.out.println(page.getPages());
        System.out.println(page.hasPrevious());
        System.out.println(page.hasNext());	
    }
}
```

结果：

```
==>  Preparing: SELECT COUNT(*) AS total FROM t_user WHERE age > ?
==> Parameters: 20(Integer)
<==    Columns: total
<==        Row: 3
<==      Total: 1
==>  Preparing: select uid, user_name, age, email from t_user where age > ? LIMIT ?
==> Parameters: 20(Integer), 3(Long)
<==    Columns: uid, user_name, age, email
<==        Row: 3, Tom, 28, test3@baomidou.com
<==        Row: 4, 晓明, 21, test@163.com
<==        Row: 5, Billie, 24, test5@baomidou.com
<==      Total: 3
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@309dcdf3]
[User(id=null, name=null, age=28, email=test3@baomidou.com, isDeleted=null), User(id=null, name=null, age=21, email=test@163.com, isDeleted=null), User(id=null, name=null, age=24, email=test5@baomidou.com, isDeleted=null)]
3
1
false
false
```

### 5.2 乐观锁

新增数据库表：

```sql
CREATE TABLE t_product
(
	id BIGINT(20) NOT NULL COMMENT '主键ID',
	NAME VARCHAR(30) NULL DEFAULT NULL COMMENT '商品名称',
	price INT(11) DEFAULT 0 COMMENT '价格',
	VERSION INT(11) DEFAULT 0 COMMENT '乐观锁版本号',
	PRIMARY KEY (id)
);
```

添加数据：

```sql
INSERT INTO t_product (id, NAME, price) VALUES (1, '外星人笔记本', 100);
```

创建实体类：

```
@Data
public class Product {
    private Long id;
    private String name;
    private Integer price;
    private Integer version;
}
```

创建ProductMapper：

```java
@Repository
public interface ProductMapper extends BaseMapper<Product> {

}
```

测试：

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {

    @Autowired
    private ProductMapper productMapper;

    @Test
    public void test03() {
        Product productLi = productMapper.selectById(1);
        System.out.println("小李查询到的价格：" + productLi.getPrice());
        Product productWang = productMapper.selectById(1);
        System.out.println("小王查询到的价格：" + productWang.getPrice());
        productLi.setPrice(productLi.getPrice() + 50);
        productMapper.updateById(productLi);
        productWang.setPrice(productWang.getPrice() - 30);
        productMapper.updateById(productWang);
        Product productBoss = productMapper.selectById(1);
        System.out.println("老板查询到的价格：" + productBoss.getPrice());
    }
}
```

结果：

```
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@474c9131]
小李查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7fb66650] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@446093644 wrapping com.mysql.cj.jdbc.ConnectionImpl@4596f8f3] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7fb66650]
小王查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6e7c351d] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1863980798 wrapping com.mysql.cj.jdbc.ConnectionImpl@4596f8f3] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=?
==> Parameters: 外星人笔记本(String), 150(Integer), 0(Integer), 1(Long)
<==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6e7c351d]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@57562473] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@2050360660 wrapping com.mysql.cj.jdbc.ConnectionImpl@4596f8f3] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=?
==> Parameters: 外星人笔记本(String), 70(Integer), 0(Integer), 1(Long)
<==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@57562473]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4bc33720] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@768669591 wrapping com.mysql.cj.jdbc.ConnectionImpl@4596f8f3] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 70, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4bc33720]
老板查询到的价格：70
```

**MyBatis Plus的乐观锁插件**：

```java
@Configuration
@MapperScan("com.liaoii.mybatisplus.mapper")
public class MyBatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }
}
```

修改实体类，指定version字段：

```java
@Data
public class Product {
    private Long id;
    private String name;
    private Integer price;
    @Version
    private Integer version;
}
```

测试：

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {

    @Autowired
    private ProductMapper productMapper;

    @Test
    public void test03() {
        Product productLi = productMapper.selectById(1);
        System.out.println("小李查询到的价格：" + productLi.getPrice());
        Product productWang = productMapper.selectById(1);
        System.out.println("小王查询到的价格：" + productWang.getPrice());
        productLi.setPrice(productLi.getPrice() + 50);
        productMapper.updateById(productLi);
        productWang.setPrice(productWang.getPrice() - 30);
        productMapper.updateById(productWang);
        Product productBoss = productMapper.selectById(1);
        System.out.println("老板查询到的价格：" + productBoss.getPrice());
    }
}
```

结果：

```
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4f5f6e45]
小李查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@31dfc6f5] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@934617920 wrapping com.mysql.cj.jdbc.ConnectionImpl@1352434e] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@31dfc6f5]
小王查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@188ac8a3] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@768669591 wrapping com.mysql.cj.jdbc.ConnectionImpl@1352434e] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?
==> Parameters: 外星人笔记本(String), 150(Integer), 1(Integer), 1(Long), 0(Integer)
<==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@188ac8a3]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@52ff99cd] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1277882374 wrapping com.mysql.cj.jdbc.ConnectionImpl@1352434e] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?
==> Parameters: 外星人笔记本(String), 70(Integer), 1(Integer), 1(Long), 0(Integer)
<==    Updates: 0
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@52ff99cd]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7b676112] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1433976386 wrapping com.mysql.cj.jdbc.ConnectionImpl@1352434e] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 150, 1
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7b676112]
老板查询到的价格：150
```

优化修改流程：

```java
@SpringBootTest
public class MyBatisPlusPluginsTest {
    
    @Autowired
    private ProductMapper productMapper;

    @Test
    public void test04() {
        Product productLi = productMapper.selectById(1);
        System.out.println("小李查询到的价格：" + productLi.getPrice());
        Product productWang = productMapper.selectById(1);
        System.out.println("小王查询到的价格：" + productWang.getPrice());
        productLi.setPrice(productLi.getPrice() + 50);
        productMapper.updateById(productLi);
        productWang.setPrice(productWang.getPrice() - 30);
        int result = productMapper.updateById(productWang);
        if (result == 0) {
            Product productN = productMapper.selectById(1);
            productN.setPrice(productN.getPrice() - 30);
            productMapper.updateById(productN);
        }
        Product productBoss = productMapper.selectById(1);
        System.out.println("老板查询到的价格：" + productBoss.getPrice());
    }

}
```

结果：

```
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@260a3a5e]
小李查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6e7c351d] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@2068450031 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 100, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6e7c351d]
小王查询到的价格：100
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@37b52340] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@43473566 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?
==> Parameters: 外星人笔记本(String), 150(Integer), 1(Integer), 1(Long), 0(Integer)
<==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@37b52340]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@671c4166] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1406221524 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?
==> Parameters: 外星人笔记本(String), 70(Integer), 1(Integer), 1(Long), 0(Integer)
<==    Updates: 0
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@671c4166]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@480ad82c] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1293465402 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 150, 1
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@480ad82c]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@52ff99cd] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1277882374 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?
==> Parameters: 外星人笔记本(String), 120(Integer), 2(Integer), 1(Long), 1(Integer)
<==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@52ff99cd]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7b676112] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1433976386 wrapping com.mysql.cj.jdbc.ConnectionImpl@21505815] will not be managed by Spring
==>  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?
==> Parameters: 1(Integer)
<==    Columns: id, name, price, version
<==        Row: 1, 外星人笔记本, 120, 2
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7b676112]
老板查询到的价格：120
```

